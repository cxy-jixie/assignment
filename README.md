# 第二章
## 2.2 三维空间位姿的描述
 1. 与二维的异同：异：增添另一个轴z与之前两者构成右手系，各轴单位向量之间满足“x”乘关系；同：只是二维的延伸，基本原理相同；
 2. 重点讨论的还是旋转与平移中坐标系之间的关系
 ### 2.2.1 三维空间姿态描述
 1. 任何两个独立的正交坐标系都可以通过一系列（不超过3次）相对于坐标轴的旋转联系起来，但其中两次旋转不能绕同一轴线.（是否可以理解成绕同一轴线的可看成一次旋转？）
 2. 旋转的顺序会影响最后的结果，故顺序不可随意交换。
 #### 2.2.1.1 正交旋转矩阵
 1. 正交旋转矩阵$（^A x， ^A y ，^Az ）^T=^ARb(^Bx,^By,^Bz)^T $
 2. 性质具有标准正交矩阵的特性比如：转置与逆相同，行列式值为1；
 3. 绕 x,y,z旋转矩阵公式如下：
 4. 利用matlab也可计算：
 ~~~ matlab
 >> R=rotx(pi/3)

R =

    1.0000         0         0
         0    0.9998   -0.0183
         0    0.0183    0.9998

>> r=roty(pi/4)

r =

    0.9999         0    0.0137
         0    1.0000         0
   -0.0137         0    0.9999

>> r1=rotz(pi/5)

r1 =

    0.9999   -0.0110         0
    0.0110    0.9999         0
         0         0    1.0000
>> trplot(R)
>> tranimate(R)
~~~
5. 正交矩阵约束条件：三列均为单位长度，且三列相互正交，故只有三个真正独立的值
#### 2.2.1.2 三角度表示法
1. 欧拉式：绕一个特定轴重复旋转但是不连续；
   卡尔丹式：绕三个不同的轴旋转
2. 所有的序列为(统称欧拉角)：
                
                (1). 欧拉：XYX XZX YXY YZY ZXZ ZYZ;
                
                (2).卡尔丹：XYZ XZY YZX YXZ ZXY ZYX;
3.   计算方法：以ZYZ序列为例：
$R=Rz(t1)*Ry(t2)*Rz(t3)
$ 
4. 欧拉角是一个三维向量，使用matlab计算旋转矩阵
~~~matlab
>> R=rotz(0.1)*roty(0.2)*rotz(0.3)%方法一

R =

    1.0000   -0.0070    0.0035
    0.0070    1.0000    0.0000
   -0.0035    0.0000    1.0000

>> gamma=tr2eul(R)%逆解？

gamma =

    0.0017    0.0035    0.0052

>> R=eul2r(0.1,0.2,0.3)%方法二

R =

    1.0000   -0.0070    0.0035
    0.0070    1.0000    0.0000
   -0.0035    0.0000    1.0000

 
>> gamma1=tr2eul(R)

gamma1 =

    0.0017    0.0035    0.0052
    %% 为什么和书上结果不同？
~~~
5. 当存在负值时出现了两组不同的解，说明旋转矩阵与欧拉角映射不是唯一的，但工具箱返回中间的角度一直为正
6. 如果中间的为0，那么两次则可看作为一次；0可看做为一个奇异点
7. 另一种顺序：横滚——俯仰——偏航角$R=Rx(t1)Ry(t2)Rz(t3) $
8. 通常x轴为前进方向，z轴垂直向下，y轴指向右手方向
9. matlab中使用“rpy2r()"求解，而逆解则用"tr2rpy(R)"
#### 2.2.1.3 奇异点与万向节锁
1. 核心装配结构：三个相互正交的框架：不会给陀螺仪内部施加外力矩，可以保证相对稳定的转动角度
2. 但在某些情况下会丢失一个自由度，会使得在数学上我们不能进行反变化，只能建立两角度的线性关系，而非得到准确数值。
3. 当 $|t|=(2k+1)pi/2$时会出现称之为奇异点
4. 解决办法：1.在航行期间避免此类情况2.引入第4个参数
#### 2.2.1.4 双向量表示法
1. 对于关节式机器人在执行器末端执行器上加上一个坐标系工具的轴线称之为z轴，再加入一个接近向量，得到一个新的完全定义的旋转矩阵：
2. matlab代码表示为：
~~~matlab
>> a=[1 0 0]'

a =

     1
     0
     0

>> o=[0 1 0]';
>> oa2r(o,a)

ans =

     0     0     1
     0     1     0
    -1     0     0
~~~
#### 2.2.1.5 绕任意向量旋转
1. 
~~~ matlab

>> R=rpy2r(0.1,0.2,0.3);
>> [t,v]=tr2angvec(R)

t =

    0.0065


v =

    0.2660    0.5354    0.8016

>>  %t为旋转角度的大小
>> %v 为绕其旋转的向量
>> [v, lambda]=eig(R)

v =

  -0.6816 + 0.0000i  -0.6816 + 0.0000i   0.2660 + 0.0000i
   0.1045 + 0.5880i   0.1045 - 0.5880i   0.5354 + 0.0000i
   0.1564 - 0.3927i   0.1564 + 0.3927i   0.8016 + 0.0000i


lambda =

   1.0000 + 0.0065i   0.0000 + 0.0000i   0.0000 + 0.0000i
   0.0000 + 0.0000i   1.0000 - 0.0065i   0.0000 + 0.0000i
   0.0000 + 0.0000i   0.0000 + 0.0000i   1.0000 + 0.0000i
   ~~~
 2. 正交旋转矩阵总有一个特征值为1;
   $RV=rV$
3. 当特征值为1时这个向量不发生改变，说明以它为轴
4. 用上述方法得到结果后可以在反推旋转矩阵
5. 绕任意轴旋转表示法可以参数化为4个数字：3个旋转轴1个旋转角度
但只有两个可知，第三个满足下式$ v1^2+v2^2+v3^2=1$即可计算
#### 2.2.1.6 单位四元数
1. 四元数是复数的扩展，也叫做超复数
$q=s+V1i+V2J+V3K $ 
2. 满足以下公式   $ i^2=j^2=k^2=ijk=-1$
3. 四元数表示为 $ q=<v1,v2,v3>$
4. matlab 中Quaternion（ryp2tr(0.1,0.2,0.3))可将其转换为四元数
5. 单位4元数可看作绕单位向量旋转了一个角度，关系为：$s=cos(t/2)$  $v=sin(t/2)  $
6. 乘法不可交换，这种不可交换性却正好符合坐标系旋转的情况。
### 2.2.2 平移与旋转组合
1. 使用一个齐次变换矩阵来实现变换，为二维的拓展
2. 两种比较实用的方法为四元数对与4x4齐次变换矩阵
# 第三章 时间与运动
## 3.1 轨迹
1. 轨迹：路径为一个空间结构，特征为平滑。
### 3.1.1 平滑的一维轨迹
1. 一般为时间的五次函数：
$s(t)=At^5+Bt^4+Ct^3+Dt^2+Et+f$
2. 其一阶导数与二阶导数均为光滑的多项式且一般情况下，速度与加速度的边界都为0；
3. 带入方程得一方阵可使用标准的线性代数方式去求解系数向量：（a,b,c,d,e,f）
4. 在matlab中可用如下函数来进行求解：
~~~matlab
s=tpoly(0,1,50);
plot(s)
[s,sd,sdd]=tpoly(0,1,50);%得到速度与加速度；
s1=tpoly(0,1,50,0.5,0);%后两个参数分别是最除速度与最终速度
mean(s1)/max(s1)
~~~
5. 为了使关节运动时间尽可能短，曲线顶部应为一条平直直线；
~~~matlab 
s=lspb(0,1,50)%混合轨迹
%同样可以通过增加参数来返回sd与sdd；
%同样可以通过增加第4个参数来指定直线段的速度
~~~
### 3.1.2 多维情况
1.轮式机器人与臂式机器人都可以用位姿表示
2.
~~~matlab
 x=mtraj(@lspb,[0 2],[1,-1],50);
 x=mtraj(@tpoly,[0 2],[1,-1],50);
 %得到50x2的矩阵每一行对应一个时间步，每一列对应轴可以生成一个标量轨迹
 %在三维空间中可以先将位姿齐次矩阵转换为一个六维向量；
 x=[transl(T)，tr2py（T）']
 ~~~
### 3.1.3 多段轨迹 
1. 为了使机器人平滑的沿一条路径移动在路径中插入几个中间点，但在接近或抵达中间点时不能减速或停止
2. 对于一个轴来说如果最大加速能力已知，那就可以计算出最小混合时间
3. 
~~~ matlab
via[4,1;4,4;5,2;2,5]%创建中间点
q=mastraj(via,[2,1],[],[4,1],0.05,0)
%[2,1]为每轴的最大速度向量
%[]为每段的运动时间向量；
%[4,1]为起点坐标
%0.05为采样时间间隔
%0为加速时间
~~~
4. 同样适用于欧拉角与横滚-俯仰-偏航角
### 3.1.4 三维空间姿态插值
1. 目的：使其更加平滑；
2. 如果位姿由正交旋转矩阵表示线性插值会破坏矩阵；但三角度表示方法可以使用线性插值法
3. 三角度的插值
~~~ matlab
r0=rotz(-1)*roty(-1);
r0=rotz(-1)*roty(-1);
r1=rotz(1)*roty(1);
rpy0=tr2rpy(r0);rpy1=tr2rpy(r1); 
rpy0=tr2rpy(r0);rpy1=tr2rpy(r1);
rpy=mtraj(@tpoly,rpy0,rpy1,50)
tranimate(rpy2tr(rpy))
~~~
4. 四元数的插值
~~~ matlab
q0=Quaternion(R0);
q1=Quaternion(R1);
q=interp(q0,q1,[0:49]'/49);
about(q)
q[Quanternion]:1x50
tranimate(q)
~~~
### 3.1.5笛卡尔运动
1. 将初始和最终位姿表示成齐次变换矩阵
2. trinterp可以沿路径方向单位的位姿插值；
3. 平移部分是线性插值而旋转部分是球形插值
4. 轨迹连续，但步距s在时间上不平滑，所以可以通过添加第三个改为一个沿路径的单位化距离向量
~~~matlab
TS=trinterp(T0,T1,lspb(0,1,50));
~~~
## 3.2 时变坐标轴
### 3.2.1 旋转坐标系
1. 物体旋转时在某个特定时间点会绕特定旋转轴，该为角速度向量
2. 时变旋转矩阵微分表达式，可利用“skew”得到
3. “vex”为逆解函数可以将斜对称矩阵转换成一个向量
### 3.2.2 增量运动
1. 对于无穷小的乘法是可以交换的
2. 
~~~ matlab
Rdelta=rotx(0.001)*roty(0.002)*rotz(0.003)
vex(Rdelta-eye(3,3))'
~~~
3. 由位移增量与旋转增量组成
4. 可以用六维向量表示两个差异较小的位姿
5. 在matlab中齐次变换表示法逆运算可使用：”delta2r“求解
### 3.2.3 惯性导航系统
1. 可测量它相对于宇宙的速度
2. 可以将位姿变换进行数值积分，进而判断飞行器的姿态
3. 要将其正交化，在工具箱中可使用”trnorm"实施。
4. 另一种方法是单位四元数方法，在工具箱中使用：q.dot(omega)；
5. 对四元数进行规范化：“q=q.unit()”
